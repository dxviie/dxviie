name: Metrics
on:
  schedule:
    - cron: "0 6 * * *"
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  github-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Read custom CSS
        id: css
        run: |
          {
            echo 'EXTRAS_CSS<<CSSEOF'
            cat extras.css
            echo 'CSSEOF'
          } >> "$GITHUB_OUTPUT"

      - uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          user: dxviie
          template: classic
          base: header, activity, community, repositories, metadata
          plugin_languages: yes
          plugin_languages_analysis_timeout: 15
          plugin_languages_categories: markup, programming
          plugin_languages_colors: github
          plugin_languages_limit: 8
          plugin_languages_recent_categories: markup, programming
          plugin_languages_recent_days: 14
          plugin_languages_recent_load: 300
          plugin_languages_sections: most-used
          plugin_languages_threshold: 0%
          plugin_lines: yes
          plugin_lines_history_limit: 1
          plugin_lines_repositories_limit: 4
          plugin_lines_sections: base
          extras_css: ${{ steps.css.outputs.EXTRAS_CSS }}
          config_display: large
          config_timezone: Europe/Brussels
          filename: github-metrics.svg

      - name: Bust README image cache
        run: |
          TIMESTAMP=$(date +%s)
          sed -i "s|github-metrics\.svg?v=[0-9]*|github-metrics.svg?v=${TIMESTAMP}|" README.md
          sed -i "s|github-metrics\.svg)|github-metrics.svg?v=${TIMESTAMP})|" README.md
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --cached --quiet || git commit -m "chore: bust metrics cache [skip ci]" && git push
